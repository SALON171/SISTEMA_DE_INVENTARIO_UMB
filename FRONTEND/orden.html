<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitud de Materiales</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: white;
            margin: 0;
            padding: 0;
            color: #4b0d21;
        }

        header {
            background-color: #800020;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .container {
            width: 90%;
            margin: auto;
            padding: 20px;
        }

        h2 {
            color: #800020;
        }

        select, input, button {
            padding: 10px;
            border: 2px solid #800020;
            border-radius: 5px;
            margin: 5px 0;
            width: 100%;
            font-size: 16px;
        }

        button {
            background-color: #800020;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #a01330;
        }

        .box {
            background-color: #f9f3f5;
            border-left: 4px solid #800020;
            padding: 15px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #800020;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #800020;
            color: white;
        }
    </style>
</head>
<body>

<header>
    <h1>Solicitud de Materiales</h1>
</header>

<div class="container">

    <div class="box">
        <h2>Solicitud de Material</h2>

        <select id="material">
            <option value="">Seleccione material</option>
        </select>

        <input type="number" id="cantidad" placeholder="Cantidad requerida" min="1">

        <select id="tipoCantidad">
            <option value="">Seleccione tipo</option>
            <option value="piezas">Piezas</option>
            <option value="paquetes">Paquetes</option>
        </select>

        <button onclick="agregarSolicitud()">Agregar a la solicitud</button>
    </div>

    <div class="box">
        <h2>Materiales Solicitados</h2>

        <table id="tablaOrden">
            <tr>
                <th>Material</th>
                <th>Cantidad</th>
            </tr>
        </table>

        <button onclick="finalizarOrden()">Finalizar orden</button>
    </div>

</div>

<script>
    // Lista de materiales
    const materiales = [
        "Caja de clips", "Grapas", "Engrapadora", "Perforadora", "Regla", "Lápiz",
        "Bolígrafo", "Tijeras", "Carpetas", "Marca textos", "Plumones",
        "Paquete hojas carta", "Paquete hojas oficio", "Cinta para pegar",
        "Toner", "Post-its", "Corrector", "Paquete de folders",
        "Protector de hojas", "Borradores de pizarrón", "Gomas",
        "Cutters", "Archiveros", "Cuadernos"
    ];

    const selectMaterial = document.getElementById("material");

    materiales.forEach(material => {
        const option = document.createElement("option");
        option.value = material;
        option.text = material;
        selectMaterial.add(option);
    });

    function agregarSolicitud() {
        const material = document.getElementById("material").value;
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const tipo = document.getElementById("tipoCantidad").value;

        if (!material || isNaN(cantidad) || cantidad <= 0 || !tipo) {
            alert("Complete correctamente la solicitud.");
            return;
        }

        const tabla = document.getElementById("tablaOrden");
        tabla.innerHTML += `
            <tr>
                <td>${material}</td>
                <td>${cantidad} ${tipo}</td>
            </tr>
        `;

        // Limpiar campos después de agregar
        document.getElementById("material").value = "";
        document.getElementById("cantidad").value = "";
        document.getElementById("tipoCantidad").value = "";
    }

    async function finalizarOrden() {
    const tabla = document.getElementById("tablaOrden");
    
    if (tabla.rows.length <= 1) {
        alert("No hay materiales en la orden.");
        return;
    }

    // 1. Capturar los datos de la tabla (omitiendo el encabezado)
    let productos = [];
    for (let i = 1; i < tabla.rows.length; i++) {
        productos.push({
            nombre: tabla.rows[i].cells[0].innerText,
            cantidad: parseInt(tabla.rows[i].cells[1].innerText)
        });
    }

    // 2. Enviar datos al servidor PHP
    try {
        const respuesta = await fetch('guardar_pedido.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productos: productos })
        });

        const resultado = await respuesta.json();
        
        if (resultado.success) {
            alert("Orden guardada con éxito. Folio: " + resultado.id_solicitud);
            window.location.href = "Resumen_pedido.html"; // Redirigir al resumen
        } else {
            alert("Error al guardar: " + resultado.error);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Error de conexión con el servidor.");
    }
}
</script>

</body>
</html>

